<html>
	<head>
	   <script src="./d3.v3.min.js"></script>
	   <script src="./dimple.v2.1.2.js"></script>
		<script type="text/javascript">
			// Again this is 0-based...
		var stream_names = ["", "Material", "Formal", "Interface", "Interaction"];
	
		   function calculate_durations(data) {
				 var previous_time = null;
				 var format = d3.time.format("%M:%S:%L");
				 for (var i = 0; i < data.length; i++) {
					 // console.log(stream_times[data[i].streamid]);
					 if (previous_time != null) {
						 data[i].duration_all_streams = (format.parse(data[i].time) - format.parse(previous_time))/1000;
					 } else {
						 data[i].duration_all_streams = 0;
					 }
					 previous_time = data[i].time;
				 };
			};
		
			function calculate_durations_per_stream(data) {
				// stream_ids are actually 1-4 so initializing 0-4 but won't use 0.
				 var stream_times = [null, null, null, null, null];
				 var format = d3.time.format("%M:%S:%L");
				 for (var i = 0; i < data.length; i++) {
					 // console.log(stream_times[data[i].streamid]);
					 if (stream_times[data[i].streamid] != null) {
						 data[i].duration_per_stream = 
						 	(format.parse(data[i].time) - format.parse(stream_times[data[i].streamid]))/1000;
					 } else {
						 data[i].duration_per_stream = 0;
					 }
					 stream_times[data[i].streamid] = data[i].time;
				 };
			};
			
			function add_stream_name(data) {
				for (var i = 0; i < data.length; i++) {
					data[i].stream_name = stream_names[data[i].streamid];
				}
				// return data;
			}
						
		</script>
		<style type="text/css" media="screen">
			.Formal { background-color: #93d1ff;}
			.Material { background-color: #fea18d;}
			.Interface { background-color: #b7e695;}
			.Interaction { background-color: #fefca2;}
				
		</style>
	</head>
	
	<body>
		<h1>Rodalytics v0.3</h1>
		<h2>Chart 1 - durations between events</h2>
		<div id="chartControls">
			<input type="button" name="btn_all_cat" value="All categories" id="btn_all_cat">
			<input type="button" name="btn_same_cat" value="Same category" id="btn_same_cat">
		</div>
		<div id="chartContainer">
		  <script type="text/javascript">
			 var svg = dimple.newSvg("#chartContainer", 1100, 600);
			 var myChart = null;
			 var myData = null;
			 d3.csv("./Everything 1a Charts.csv", function (data) {
			  	 // data = dimple.filterData(data, "id", "3");
			 	 // console.log(data);

	 		    myData = data;
				 
				 // possibly change csv file format using this
				 calculate_durations(myData);
				 calculate_durations_per_stream(myData);
 				 myData.map(function (d) {
 				 	d.duration = d.duration_all_streams;
 				 })
				 add_stream_name(myData);
				 // console.log(myData);
				 myChart = new dimple.chart(svg, myData);
	 		    myChart.setBounds(60, 30, 1000, 530);
	 		    var x = myChart.addTimeAxis("x", "time", "%M:%S:%L", "%M:%S");
				 x.timePeriod = d3.time.seconds;
				 x.timeInterval = 10;
	 		    myChart.addCategoryAxis("y", "stream_name");
	 		    myChart.addMeasureAxis("z", "duration");
	 		    myChart.addLegend(700, 10, 360, 50, "left");
				 myChart.addSeries("stream_name");
				 // myChart.addSeries("comment", null);
	 		    myChart.draw();
	 		 });
			 
			d3.select("#btn_all_cat").on("click", function() {
				myData.map(function (d) {
					d.duration = d.duration_all_streams;
				})
				myChart.draw(1000);
			});

			d3.select("#btn_same_cat").on("click", function() {
				myData.map(function (d) {
					d.duration = d.duration_per_stream;
				})
			 	myChart.draw(1000);
			});
		  </script>
		</div>
		
		<h2>Chart 2 - event trends</h2>
		<div id="chartControls2">
			<input type="button" name="btn2_cat_all" value="All streams" id="btn2_cat_all">
			<input type="button" name="btn2_cat_1" value="Material" id="btn2_cat_1">
			<input type="button" name="btn2_cat_2" value="Formal" id="btn2_cat_2">
			<input type="button" name="btn2_cat_3" value="Interface" id="btn2_cat_3">
			<input type="button" name="btn2_cat_4" value="Interaction" id="btn2_cat_4">
		</div>
		<div id="chartContainer2">
		  <script type="text/javascript">
			 var svg2 = dimple.newSvg("#chartContainer2", 1100, 600);
			 var myChart2 = null;
			 var myData2 = null;
			 var minTime, maxTime, maxDuration = null;
			 var timeFormat = d3.time.format("%M:%S:%L");
			 
			 d3.csv("./Everything 1a Charts.csv", function (data) {
			  	 // data = dimple.filterData(data, "id", "3");
			 	 // console.log(data);

	 		    myData2 = data;
				 
				 // possibly change csv file format using this
				 calculate_durations(myData2);
				 calculate_durations_per_stream(myData2);
 				 myData2.map(function (d) {
 				 	d.duration = d.duration_all_streams;
 				 })
				 add_stream_name(myData2);
				 // console.log(myData2);
				 
				 minTime = d3.min(myData2, function (d) {
				         return d.time;
				 })
				 
				 maxTime = d3.max(myData2, function (d) {
					 return d.time;
				 })
				 
				 maxDuration = d3.max(myData2, function (d) {
				       return d.duration_per_stream;
				 })

				 myChart2 = new dimple.chart(svg2, myData2);
	 		    myChart2.setBounds(60, 30, 1000, 530);
	 		    var x = myChart2.addTimeAxis("x", "time", "%M:%S:%L", "%M:%S");
				 // x.addOrderRule("Date");
				 // x.overrideMax = maxTime;
				 x.timePeriod = d3.time.seconds;
				 x.timeInterval = 10;
				 x.overrideMin = timeFormat.parse(minTime);
				 x.overrideMax = timeFormat.parse(maxTime);
				 
				 var y = myChart2.addMeasureAxis("y", "duration_per_stream");
				 y.overrideMax = maxDuration;
				 // myChart2.addSeries("comment");
				 myChart2.addSeries("stream_name", dimple.plot.bubble);
	 		    
				 myChart2.assignColor("Material", "#fea18d");
				 myChart2.assignColor("Formal", "#93d1ff");
				 myChart2.assignColor("Interface", "#b7e695");
				 myChart2.assignColor("Interaction", "#fefca2");
				 
				 // myChart2.addLegend(140, 10, 360, 20, "left");
	 		    myChart2.draw();

	 		 });

 			d3.select("#btn2_cat_all").on("click", function() {
 				myChart2.data = myData2;
 				myChart2.draw(1000);
 			});
			d3.select("#btn2_cat_1").on("click", function() {
				myChart2.data = dimple.filterData(myData2, "streamid", "1");
				myChart2.draw(1000);
			});
			d3.select("#btn2_cat_2").on("click", function() {
				myChart2.data = dimple.filterData(myData2, "streamid", "2");
				myChart2.draw(1000);
			});
			d3.select("#btn2_cat_3").on("click", function() {
				myChart2.data = dimple.filterData(myData2, "streamid", "3");
				myChart2.draw(1000);
			});
			d3.select("#btn2_cat_4").on("click", function() {
				myChart2.data = dimple.filterData(myData2, "streamid", "4");
				myChart2.draw(1000);
			});

		  </script>
		</div>
		
		

		<h2>Stats 1 - Co-occurrence / Event-transition matrix</h2>
		<div id="stats1">
		  <script type="text/javascript">
			 d3.csv("./Everything 1a Charts.csv", function (data) {
				 // We're translating streamids 1-4 to be 0-3 for our purposes!
				 // Remember this when rendering!!!
				 // stream_cooccurrence[from][to]
				 var stream_cooccurrence = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
				 // assume at least one piece of data!
				 var previous_streamid = (data[0].streamid-1);
				 var this_streamid = -1;
				 for (var i = 1; i < data.length; i++) {
					 this_streamid = (data[i].streamid-1);
					 stream_cooccurrence[previous_streamid][this_streamid]++;
					 previous_streamid = this_streamid;
				 }
				 
				 // console.log(stream_cooccurrence);
				 
				 // Output the data that we've calculated
				 var mytable = d3.select("#stats1").append("table");
				 var heading_row = mytable.append("tr");
				 heading_row.append("th").text("x");
				 for (var i = 0; i < 4; i++) {
					 var label = heading_row.append("th");
					 label.text(stream_names[(i+1)]);
					 label.classed(stream_names[(i+1)], "true");
				 };

				 for (var i = 0; i < stream_cooccurrence.length; i++) {
					 var myrow = mytable.append("tr");
					 var label = myrow.append("td");
					 label.text(stream_names[i+1]);
					 label.classed(stream_names[i+1], "true");
					 for (var j = 0; j < stream_cooccurrence[i].length; j++) {
						 myrow.append("td").text(stream_cooccurrence[i][j]);
					 }
				 }
	 		 });
		  </script>
		</div>
		
		<h2>Stats 2 - Activity Summary</h2>
		<div id="stats2">
		  <script type="text/javascript">
			 d3.csv("./Everything 1a Charts.csv", function (data) {
				 
				 var mytable = d3.select("#stats2").append("table");
				 // could refactor & do forEach on streamname list?
				 var heading_row = mytable.append("tr");
				 heading_row.append("th").text("Stream");
				 heading_row.append("th").text("Instances");

				 for (var i = 1; i < 5; i++) {
					 var myrow = mytable.append("tr");
					 var label = myrow.append("td");
					 label.text(stream_names[i]);
					 label.classed(stream_names[i], "true");

					 // filter is string not int
					 var stream = dimple.filterData(data, "streamid", ""+i);
					 myrow.append("td").text(stream.length);
				 }
				 
	 		 });
		  </script>
		</div>		
		
		<h2>Stats 3 - Duration stats per stream</h2>
		<div id="stats3">
		  <script type="text/javascript">
			 d3.csv("./Everything 1a Charts.csv", function (data) {
				 calculate_durations_per_stream(data);
				 
				 var mytable = d3.select("#stats3").append("table");
				 // could refactor & do forEach on streamname list?
				 var heading_row = mytable.append("tr");
				 heading_row.append("th").text("Stream");
				 heading_row.append("th").text("Min");
				 heading_row.append("th").text("Median");
				 heading_row.append("th").text("Mean");
				 heading_row.append("th").text("Std Dev");
				 heading_row.append("th").text("Max");

				 var three_sf = d3.format(".3g");

				 for (var i = 1; i < 5; i++) {
					 var myrow = mytable.append("tr");
					 var label = myrow.append("td");
					 label.text(stream_names[i]);
					 label.classed(stream_names[i], "true");

					 // filter is string not int
					 var stream = dimple.filterData(data, "streamid", ""+i);
					 var get_duration_per_stream = function (d) {
						 return d.duration_per_stream;
					 };
					 
					 myrow.append("td").text(three_sf(d3.min(stream, get_duration_per_stream)));
					 myrow.append("td").text(three_sf(d3.median(stream, get_duration_per_stream)));
					 myrow.append("td").text(three_sf(d3.mean(stream, get_duration_per_stream)));
					 myrow.append("td").text(three_sf(d3.deviation(stream, get_duration_per_stream)));
					 myrow.append("td").text(three_sf(d3.max(stream, get_duration_per_stream)));

				 }
				 
	 		 });
		  </script>
		</div>

	</body>
	
</html>