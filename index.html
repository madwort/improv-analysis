<html>
	<head>
	   <script src="./d3.v3.min.js"></script>
	   <script src="./dimple.v2.1.2.js"></script>
		<script type="text/javascript">
			// Again this is 0-based...
			var stream_names = ["", "Material", "Formal", "Interface", "Interaction"]
	
		   function calculate_durations(data) {
				 var previous_time = null;
				 var format = d3.time.format("%M:%S:%L");
				 for (var i = 0; i < data.length; i++) {
					 // console.log(stream_times[data[i].streamid]);
					 if (previous_time != null) {
						 data[i].duration = (format.parse(data[i].time) - format.parse(previous_time))/1000;
					 } else {
						 data[i].duration = 0;
					 }
					 previous_time = data[i].time;
				 };
			};
		
			function calculate_durations_per_stream(data) {
				// stream_ids are actually 1-4 so initializing 0-4 but won't use 0.
				 var stream_times = [null, null, null, null, null];
				 var format = d3.time.format("%M:%S:%L");
				 for (var i = 0; i < data.length; i++) {
					 // console.log(stream_times[data[i].streamid]);
					 if (stream_times[data[i].streamid] != null) {
						 data[i].duration = (format.parse(data[i].time) - format.parse(stream_times[data[i].streamid]))/1000;
					 } else {
						 data[i].duration = 0;
					 }
					 stream_times[data[i].streamid] = data[i].time;
				 };
			};

			
			function switch_stream_id_for_stream_name(data) {
				for (var i = 0; i < data.length; i++) {
					data[i].streamid = stream_names[data[i].streamid];
				}
				// return data;
			}
						
		</script>
	</head>
	
	<body>
		<h1>Rodalytics v0.2</h1>
		<h2>Chart 1 - duration between events of all categories</h2>
		<div id="chartContainer">
		  <script type="text/javascript">
			 var svg = dimple.newSvg("#chartContainer", 1100, 600);
			 d3.csv("./Everything 1a Charts.csv", function (data) {
			  	 // data = dimple.filterData(data, "id", "3");
			 	 // console.log(data);
				 
				 // possibly change csv file format using this
				 calculate_durations(data);
				 switch_stream_id_for_stream_name(data);
	 		    var myChart = new dimple.chart(svg, data);
	 		    myChart.setBounds(60, 30, 1000, 530);
	 		    myChart.addTimeAxis("x", "time", "%M:%S:%L", "%M:%S");
	 		    myChart.addCategoryAxis("y", "streamid");
	 		    myChart.addMeasureAxis("z", "duration");
	 		    myChart.addSeries("duration", dimple.plot.bubble);
	 		    myChart.addLegend(140, 10, 360, 20, "left");
				 myChart.addSeries("comment");
	 		    myChart.draw();
	 		 });
		  </script>
		</div>

		<h2>Chart 2 - duration between events of same category</h2>
		<div id="chartContainer2">
		  <script type="text/javascript">


			 var svg2 = dimple.newSvg("#chartContainer2", 1100, 600);
			 d3.csv("./Everything 1a Charts.csv", function (data) {
				 calculate_durations_per_stream(data);
				 switch_stream_id_for_stream_name(data);
	 		    var myChart2 = new dimple.chart(svg2, data);
	 		    myChart2.setBounds(60, 30, 1000, 530);
	 		    myChart2.addTimeAxis("x", "time", "%M:%S:%L", "%M:%S");
	 		    myChart2.addCategoryAxis("y", "streamid");
	 		    myChart2.addMeasureAxis("z", "duration");
	 		    myChart2.addSeries("duration", dimple.plot.bubble);
	 		    myChart2.addLegend(140, 10, 360, 20, "left");
				 myChart2.addSeries("comment");
	 		    myChart2.draw();
	 		 });
		  </script>
		</div>
		
		<h2>Stats 1 - Co-occurrence / State-transition matrix</h2>
		<div id="stats1">
		  <script type="text/javascript">
			 d3.csv("./Everything 1a Charts.csv", function (data) {
				 // We're translating streamids 1-4 to be 0-3 for our purposes!
				 // Remember this when rendering!!!
				 // stream_cooccurrence[from][to]
				 var stream_cooccurrence = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
				 // assume at least one piece of data!
				 var previous_streamid = (data[0].streamid-1);
				 var this_streamid = -1;
				 for (var i = 1; i < data.length; i++) {
					 this_streamid = (data[i].streamid-1);
					 stream_cooccurrence[previous_streamid][this_streamid]++;
					 previous_streamid = this_streamid;
				 }
				 // console.log(stream_cooccurrence);
				 var mytable = d3.select("#stats1").append("table");
				 var heading_row = mytable.append("tr");
				 heading_row.append("th").text("x");
				 for (var i = 0; i < 4; i++) {
					 heading_row.append("th").text(stream_names[(i+1)]);
				 };

				 for (var i = 0; i < stream_cooccurrence.length; i++) {
					 var myrow = mytable.append("tr");
					 myrow.append("td").text(stream_names[(i+1)]);
					 for (var j = 0; j < stream_cooccurrence[i].length; j++) {
						 myrow.append("td").text(stream_cooccurrence[i][j]);
					 }
				 }
	 		 });
		  </script>
		</div>
		
	</body>
	
</html>